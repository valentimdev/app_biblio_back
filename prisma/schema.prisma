generator client {
  provider = "prisma-client-js"

}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RoleEnum {
  ADMIN
  USER
}

enum UserStatus {
  ACTIVE
  BANNED
}

enum NotificationType {
  GENERIC
  EVENT_REGISTRATION
  EVENT_STATUS
  EVENT_REMINDER
  BOOK_RENTAL
}

model User {
  id           String   @id @default(uuid())
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt

  name         String
  email        String   @unique
  matricula    String  @unique
  passwordHash String   @map("password")
  role         RoleEnum @default(USER)
  imageUrl     String?  @map("image_url")
  status       UserStatus @default(ACTIVE)

  // Relations
  events        Event[]           @relation("UserEvents") // events created by admin
  registrations EventRegistration[]
  books         Book[]
  rentals       Rental[]
  notifications Notification[]

  @@map("users")
}
model Book {
  id              String   @id @default(uuid())
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  title           String
  author          String
  isbn            String   @unique
  description     String?
  imageUrl        String?  @map("image_url")
  totalCopies     Int      @map("total_copies")
  availableCopies Int      @map("available_copies")

  isHidden        Boolean  @default(false) @map("is_hidden")      // se true, some do catálogo do aluno
  loanEnabled     Boolean  @default(true)  @map("loan_enabled")   // se false, não pode alugar

  adminId         String   @map("admin_id")
  admin           User     @relation(fields: [adminId], references: [id])

  rentals         Rental[]

  @@map("books")
}

model Rental {
  id         String   @id @default(uuid())
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  userId     String   @map("user_id")
  bookId     String   @map("book_id")
  rentalDate DateTime @map("rental_date")
  dueDate    DateTime @map("due_date")
  returnDate DateTime? @map("return_date")

  user User @relation(fields: [userId], references: [id])
  book Book @relation(fields: [bookId], references: [id])

  @@map("rentals")
}

model Event {
  id          String   @id @default(uuid())
  title       String
  description String?

  
  registrationStartTime DateTime? @map("registration_start_time")
  registrationEndTime   DateTime? @map("registration_end_time")


  eventStartTime        DateTime  @map("event_start_time")
  eventEndTime          DateTime  @map("event_end_time")

  startTime   DateTime @map("start_time")
  endTime     DateTime @map("end_time")


  location    String
  imageUrl    String?  @map("image_url")
  lecturers   String?
  seats      Int?
  isDisabled Boolean @default(false)
  isFull Boolean @default(false)
  // Admin creator
  adminId String
  admin   User     @relation("UserEvents", fields: [adminId], references: [id])
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Registrations
  registrations EventRegistration[]

  @@map("events")
}

model EventRegistration {
  userId       String
  eventId      String
  registeredAt DateTime @default(now()) @map("registered_at")

  user  User  @relation(fields: [userId], references: [id])
  event Event @relation(fields: [eventId], references: [id])

  @@id([userId, eventId])
  @@map("event_registrations")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  title     String
  message   String
  type      NotificationType @default(GENERIC)
  data      Json?
  readAt    DateTime?        @map("read_at")
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId, readAt])
  @@map("notifications")
}